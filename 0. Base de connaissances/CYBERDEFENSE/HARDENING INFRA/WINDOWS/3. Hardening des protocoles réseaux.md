

|   |   |   |
|---|---|---|
|`External Reconnaissance`|`T1589`|This portion of an attack is extremely hard to detect and defend against. An attacker does not have to interact with your enterprise environment directly, so it's impossible to tell when it is happening. What can be done is to monitor and control the data you release publically to the world. Job postings, documents (and the metadata left attached), and other open information sources like BGP and DNS records all reveal something about your enterprise. Taking care to `scrub` documents before release can ensure an attacker cannot glean user naming context from them as an example. The same can be said for not providing detailed information about tools and equipment utilized in your networks via job postings.|
|`Internal Reconnaissance`|`T1595`|For reconnaissance of our internal networks, we have more options. This is often considered an active phase and, as such, will generate network traffic which we can monitor and place defenses based on what we see. `Monitoring network traffic` for any suspicious bursts of packets of a large volume from any one source or several sources can be indicative of scanning. A properly configured `Firewall` or `Network Intrusion Detection System` (`NIDS`) will spot these trends quickly and alert on the traffic. Depending on the tool or appliance, it may even be able to add a rule blocking traffic from said hosts proactively. The utilization of network monitoring coupled with a SIEM can be crucial to spotting reconnaissance. Properly tuning the Windows Firewall settings or your EDR of choice to not respond to ICMP traffic, among other types of traffic, can help deny an attacker any information they may glean from the results.|
|`Poisoning`|`T1557`|Utilizing security options like `SMB message signing` and `encrypting traffic` with a strong encryption mechanism will go a long way to stopping poisoning & man-in-the-middle attacks. SMB signing utilizes hashed authentication codes and verifies the identity of the sender and recipient of the packet. These actions will break relay attacks since the attacker is just spoofing traffic.|
|`Password Spraying`|`T1110/003`|This action is perhaps the easiest to defend against and detect. Simple logging and monitoring can tip you off to password spraying attacks in your network. Watching your logs for multiple attempts to login by watching `Event IDs 4624` and `4648` for strings of invalid attempts can tip you off to password spraying or brute force attempts to access the host. Having strong password policies, an account lockout policy set, and utilizing two-factor or multi-factor authentication can all help prevent the success of a password spray attack. For a deeper look at the recommended policy settings, check out this [article](https://www.netsec.news/summary-of-the-nist-password-recommendations-for-2021/) and the [NIST](https://pages.nist.gov/800-63-3/sp800-63b.html) documentation.|
|`Credentialed Enumeration`|`TA0006`|There is no real defense you can put in place to stop this method of attack. Once an attacker has valid credentials, they effectively can perform any action that the user is allowed to do. A vigilant defender can detect and put a stop to this, however. Monitoring for unusual activity such as issuing commands from the CLI when a user should not have a need to utilize it. Multiple RDP requests sent from host to host within the network or movement of files from various hosts can all help tip a defender off. If an attacker manages to acquire administrative privileges, this can become much more difficult, but there are network heuristics tools that can be put in place to analyze the network constantly for anomalous activity. Network segmentation can help a lot here.|
|`LOTL`|N/A|It can be hard to spot an attacker while they are utilizing the resources built-in to host operating systems. This is where having a `baseline of network traffic` and `user behavior` comes in handy. If your defenders understand what the day-to-day regular network activity looks like, you have a chance to spot the abnormal. Watching for command shells and utilizing a properly configured `Applocker policy` can help prevent the use of applications and tools users should not have access to or need.|
|`Kerberoasting`|`T1558/003`|Kerberoasting as an attack technique is widely documented, and there are plenty of ways to spot it and defend against it. The number one way to protect against Kerberoasting is to `utilize a stronger encryption scheme than RC4` for Kerberos authentication mechanisms. Enforcing strong password policies can help prevent Kerberoasting attacks from being successful. `Utilizing Group Managed service accounts` is probably the best defense as this makes Kerberoasting no longer possible. Periodically `auditing` your users' account permissions for excessive group membership can be an effective way to spot issues.|



# 1. LLMNR / NBT-NS & MDNS [T1557.001](https://attack.mitre.org/techniques/T1557/001)


- Désactiver Netbios, LLMNR et MDNS
- Activer les signatures smb
- NDR
- Segmentation réseau


## Désactiver LLMNR par GPO

Computer Configuration --> Administrative Templates --> Network --> DNS Client
Activer "Turn off Multicast Name Resolution".


## Désactiver NBT-NS avec Script powershell

Créer script PowerShell suivant

```powershell
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\NetBT\Parameters\Interfaces\tcpip_*' -Name NetbiosOptions -Value 2 -Verbose
```

Le configurer au démarrage sur les machines

- **Configuration ordinateur > Paramètres Windows > Scripts (démarrage/arrêt)**

## Désactiver MDNS par GPO

**1** - Accédez à : **Configuration ordinateur > Préférences > Paramètres Windows > Registre**

**2** - Effectuez un clic droit, puis sous "**Nouveau**" choisissez "**Élément Registre**".

- **Action** : Mettre à jour (même si cette valeur n'existe pas par défaut)
- **Ruche** : HKEY_LOCAL_MACHINE
- **Chemin d'accès de la clé** : SYSTEM\CurrentControlSet\Services\Dnscache\Parameters
- **Nom de valeur** : EnableMDNS
- **Type de valeur** : REG_DWORD
- **Données de valeur** : 0


# Detection

https://www.praetorian.com/blog/a-simple-and-effective-way-to-detect-broadcast-name-resolution-poisoning-bnrp/

1. Monitorer le trafic sur les ports UDP 5355 et 137 si LLMNR et NBT-NS sont désactivés
2. Monitorer les changements de valeur DWORD sur EnableMulticast dans HKLM\Software\Policies\Microsoft\Windows NT\DNSClient
3. Surveiller les services/daemons nouvellement créés dans les journaux d'événements Windows pour les ID d'événements 4697 et 7045. Déployer un outil de détection du spoofing LLMNR/NBT-NS.
4. Surveiller le trafic réseau provenant de dispositifs matériels inconnus ou inattendus. Les métadonnées du trafic réseau local (telles que l'adressage MAC de la source) ainsi que l'utilisation de protocoles de gestion du réseau tels que DHCP peuvent être utiles pour identifier le matériel.


---

# 2. KERBEROS


1. Utiliser les gMSA et MSA
2. Logs le nombre anormal de requêtes de TGS (computer Configuration -> Security Settings -> Advanced Audit Policy Configuration -> Audit Policies -> Account Logon -> Audit Kerberos Authentication service )
3. Mettre les admins du domaine dans le groupe Protected Users
4. 

---

3. 