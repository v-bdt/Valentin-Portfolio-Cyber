
> [!OBJECTIF]
> Enumérer les protocoles identifiés précédemment


- [[#FTP (21)]]
- [[#SSH (22)]]
- [[#TELNET (23)]]
- [[#SMTP/s (25,465,587)]]
- [[#DNS (53)]]
- [[#SMB (139,445)]]
- [[#KERBEROS (88)]]
- [[#LDAP (389)]]
- [[#SNMP (161/162)]]
- [[#HTTP(s) (80, 443)]]
- [[#NFS (111,2049)]]
- [[#IMAP (143, 993) / POP3 (110, 995)]]
- [[#MYSQL (3306)]]
- [[#MSSQL (1433)]]
- [[#ORACLE TNS (1521)]]
- [[#IPMI (623 udp)]]
- [[#RSYNC (873)]]
- [[#R-SERVICES (512, 513, 514)]]
- [[#RDP (3389)]]
- [[#WINRM (5985, 5986)]]
- [[#WMI (135)]]


# #FTP (21)


## *Banner Grabbing*

```bash
nc -vn <IP> 21
```

```bash
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```

## *Anonymous login* + commandes

```bash
ftp <IP>
>anonymous
>anonymous
>passive # Desactive le mode passif
>status # Affiche les paramètres du serveur
>debug # + d'infos
>trace # + d'infos
>ls -a # List all files (even hidden) (yes, they could be hidden)
>ls -Ra # Listing récursif
>get file # Télécharger un fichier
>put file # upload d'un fichier
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```

Télécharger tous les fichiers disponibles

```bash
wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136
```

## EXPLOITATION [[FTP]]



---

# #SSH (22)

[[SSH]]
## *Banner Grabbing*

```bash
nc -vn <IP> 22
```

## *Audit automatisé*

https://github.com/jtesta/ssh-audit

```bash
python3 ssh-audit.py [-1246pbcnjvlt] <host>
```

Connexion avec clé privé

```bash
ssh ceil@10.129.15.254 -i ../key
```

---

# #TELNET (23)

## *Banner Grabbing*

```bash
nc -vn <IP> 23
```

```bash
nmap -n -sV -Pn --script "*telnet* and safe" -p 23 -vv <IP>
```


---

# #SMTP/s (25,465,587)


```bash
nmap -p25 -sV -sC 10.10.10.10 -v
```

```bash
nmap -p25 --script smtp-commands 10.10.10.10 -v
```

Vérifier si possible d'envoyer des mails avec des adresses qui n'existent pas ou usurper @ existante
```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
## *Banner Grabbing*

```bash
nc -vn <IP> 25
```

```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```

## TELNET

```bash
telnet 10.129.14.128 25
HELO hostname
```

| **Command**  | **Description**                                                                                  |
| ------------ | ------------------------------------------------------------------------------------------------ |
| `AUTH PLAIN` | AUTH is a service extension used to authenticate the client.                                     |
| `HELO`       | The client logs in with its computer name and thus starts the session.                           |
| `MAIL FROM`  | The client names the email sender.                                                               |
| `RCPT TO`    | The client names the email recipient.                                                            |
| `DATA`       | The client initiates the transmission of the email.                                              |
| `RSET`       | The client aborts the initiated transmission but keeps the connection between client and server. |
| `VRFY`       | The client checks if a mailbox is available for message transfer.                                |
| `EXPN`       | The client also checks if a mailbox is available for messaging with this command.                |
| `NOOP`       | The client requests a response from the server to prevent disconnection due to time-out.         |
| `QUIT`       | The client terminates the session.                                                               |
| CONNECT      | CONNECT 10.129.14.128:25 HTTP/1.0 -> connexion avec web proxy                                    |
Response codes:
https://serversmtp.com/smtp-error/

## USER enum

#### Metasploit (wordlist)

```bash
msfconsole
use scanner/smtp/smtp_enum
```

#### SMTP-USER-ENUM (wordlist)

verifier "no such user" et non pas no-result, augmenter le temps de reponse si c'est le cas
```bash
smtp-user-enum -M VRFY -U /home/kali/Desktop/footprinting-wordlist.txt -t 10.129.4.64 -D <domain> -vv -w 12
```

script bien pratique pour n'afficher que les users existants + fichier en sortie.
```bash
for user in $(cat /home/kali/Desktop/footprinting-wordlist.txt); do smtp-user-enum -M VRFY -u $user -t 10.129.4.64 -D <domain> -vv -w 12 | grep "exists" | tee -a users_smtp.txt; done
```

> [!TIP]
> Tester les méthodes EXPN et RCPT également

#### Nmap

```bash
nmap -p25 --script smtp-enum-users 10.129.4.64 -v
```

## *Trouver les serveurs mx de l'organisation*

```bash
dig +short mx <domain>
```

```
host -t MX <DOMAIN>
```

https://mxtoolbox.com/

##  [[SMTP - IMAP - POP3|EXPLOITATION SMTP]]


---

# #DNS (53)


## *Banner Grabbing*

```bash
nmap -p53 --script dns-nsid <ip>
```

```bash
dig version.bind CHAOS TXT @DNS
```

## NS 

```bash
dig ns inlanefreight.htb @10.129.14.128
```
## *Enregistrement ANY*

```bash
dig any victim.com @<DNS_IP>
```

## *Transfert de zone*

### Sans domaine

```bash
dig axfr @<DNS_IP> | tee -a subdomains
```

### Avec domaine

```bash
dig axfr @<DNS_IP> <DOMAIN> | tee -a subdomains
```

```bash
fierce --domain <DOMAIN> --dns-servers <DNS_IP> #Will try to perform a zone transfer against every authoritative name server and if this doesn'twork, will launch a dictionary attack
```

Mise en forme des sous domaines

```sh
cat subdomains | awk '{print $1}' | sed '/^$/d' | sed '/^inlanefreight/d' | sed 's/\.$//g' | sed '/;/d' > subdomains.txt
```

supprimer les \n (plus qu'a copier coller dans le fichier hosts)

```sh
tr '\n' ' ' < subdomains.txt
```

## [[OFFSEC/PENTEST/2. INFRA/5. EXPLOITATION/0. Services communs/DNS|Exploitation DNS]]


---

# #MSRPC (135)


```
impacket-rpcdump -p 135 <ip>
```

PrintNightmare ? [[PrintNightmare]]

```shell
rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'
```


---

# #SMB (139,445)

### Footprinting

```bash
sudo nmap 10.129.14.128 -sV -sC -p139,445
```

```bash
enum4linux -a <HOST>
```

Lister les shares

```bash
smbclient -N -L //10.129.42.253
smbclient -U bob //10.129.42.253/users
smbclient -N //10.129.42.253/users
```

### SMBMap

Lister un partage de manière récursive

```shell
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -r 'Department Shares' --dir-only
```

### **NETEXEC**

https://www.netexec.wiki/

Tester accès NULL session

```bash
nxc smb 192.168.1.0/24 -u '' -p ''
```

Tester accès Guest session

```bash
nxc smb 192.168.1.0/24 -u 'guest' -p ''
```

Lister les shares

```bash
nxc smb 192.168.1.0/24 -u '' -p '' --shares
```

Lister tous les fichiers lisibles

```bash
nxc smb 10.10.10.10 -u 'user' -p 'pass' -M spider_plus
```

Télécharger tous les fichiers lisibles:

```bash
nxc smb 10.10.10.10 -u 'user' -p 'pass' -M spider_plus -o DOWNLOAD_FLAG=True
```

Télécharger 1 fichier:

```bash
nxc smb 172.16.251.152 -u user -p pass --get-file \\Windows\\Temp\\whoami.txt /tmp/whoami.txt
```

Upload 1 fichier:
```bash
nxc smb 172.16.251.152 -u user -p pass --put-file /tmp/whoami.txt \\Windows\\Temp\\whoami.txt
```

## RPC

```BASH
rpcclient -U "" 10.129.14.128
```

```
rpcclient -U "" -N 172.16.2.5
```

| **Query**                 | **Description**                                                    |
| ------------------------- | ------------------------------------------------------------------ |
| `srvinfo`                 | Server information.                                                |
| `enumdomains`             | Enumerate all domains that are deployed in the network.            |
| `querydominfo`            | Provides domain, server, and user information of deployed domains. |
| `netshareenumall`         | Enumerates all available shares.                                   |
| `netsharegetinfo <share>` | Provides information about a specific share.                       |
| `enumdomusers`            | Enumerates all domain users.                                       |
| `queryuser <RID>`         | Provides information about a specific user.                        |
| `querygroup <RID>`        | Provides information about a specific group.                       |
https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html

### Bruteforce RID

```bash
nxc smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --rid-brute
```

```BASH
for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```

```BASH
impacket-samrdump 10.129.14.128
```

### EXPLOITATION [[SMB]]

---

# #KERBEROS (88)

## Footprint

```bash
sudo nmap 10.129.14.128 -p88 -sV -sC
```


[[1. KERBEROASTING]]

[[2. AS-REP ROASTING]]

---
# #LDAP (389)


## Footprint

```bash
sudo nmap 10.129.205.18 -p389 -sV -sC -vv
```


---

# #SNMP (161/162)

Communauté Publique:

```bash
snmpwalk -v 2c -c public 10.129.42.253
```

Communauté Privé:

```bash
snmpwalk -v 2c -c private  10.129.42.253 
```

Bruteforce de community strings:

```bash
onesixtyone -c /usr/share/seclists/Discovery/SNMP/snmp.txt 10.129.42.254
```

Tester communauté identifiée sur snmp v1 et v2c.

Bruteforce d'OID

```shell-session
braa public@10.129.14.128:.1.3.6.*
```


---

# #HTTP(s) (80, 443)


### [[6. Applications (Web)]]


---

# #NFS (111,2049)

## Footprint

```bash
sudo nmap 10.129.14.128 -p111,2049 -sV -sC
```

```bash
sudo nmap --script nfs* 10.129.14.128 -sV -p111,2049
```

#### Lister les partages NFS

```bash
showmount -e 10.129.14.128
```

```bash
netexec nfs 10.129.7.58 --enum-shares
```
https://www.netexec.wiki/nfs-protocol/download-and-upload-files
#### root escape

```bash
netexec nfs <ip> --ls '/'
```

#### Monter partage NFS
(possible ensuite de créer users et groupes correspondants afin de modifier les fichiers)

```bash
mkdir target-NFS
sudo mount -t nfs 10.10.11.78:/ ./target-NFS/ -o nolock
cd target-NFS
tree .
```

Lister avec UID & GID

```bash
ls -n mnt/nfs/
```

Démonter partage

```bash
sudo umount ./target-NFS
```


---

# #IMAP (143, 993) / # #POP3 (110, 995)

### Footprinting

```bash
nc -nv 10.129.42.195 110
```

```bash
sudo nmap 10.129.14.128 -sV -p110,143,993,995 -sC
```

Scripts

```bash
find / -type f -name 'imap*' &>/dev/null | grep scripts
```

```bash
find / -type f -name 'pop3*' &>/dev/null | grep scripts
```
#### IMAP Commands

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-imap.html?highlight=imap#syntax

| **Command**                     | **Description**                                                                                               |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| `1 LOGIN username password`     | User's login.                                                                                                 |
| `1 LIST "" *`                   | Lists all directories.                                                                                        |
| `1 CREATE "INBOX"`              | Creates a mailbox with a specified name.                                                                      |
| `1 DELETE "INBOX"`              | Deletes a mailbox.                                                                                            |
| `1 RENAME "ToRead" "Important"` | Renames a mailbox.                                                                                            |
| `1 LSUB "" *`                   | Returns a subset of names from the set of names that the User has declared as being `active` or `subscribed`. |
| `1 SELECT INBOX`                | Selects a mailbox so that messages in the mailbox can be accessed.                                            |
| `1 UNSELECT INBOX`              | Exits the selected mailbox.                                                                                   |
| `1 FETCH <ID> all`              | Retrieves data associated with a message in the mailbox.                                                      |
| 1 FETCH (BODY[TEXT]             | Retrieves contenu du mail                                                                                     |
| `1 CLOSE`                       | Removes all messages with the `Deleted` flag set.                                                             |
| `1 LOGOUT`                      | Closes the connection with the IMAP server.                                                                   |
#### POP3 Commands

|**Command**|**Description**|
|---|---|
|`USER username`|Identifies the user.|
|`PASS password`|Authentication of the user using its password.|
|`STAT`|Requests the number of saved emails from the server.|
|`LIST`|Requests from the server the number and size of all emails.|
|`RETR id`|Requests the server to deliver the requested email by ID.|
|`DELE id`|Requests the server to delete the requested email by ID.|
|`CAPA`|Requests the server to display the server capabilities.|
|`RSET`|Requests the server to reset the transmitted information.|
|`QUIT`|Closes the connection with the POP3 server.|

Lecture de mails avec identifiants et curl

```bash
curl -k 'imaps://10.129.14.128' --user cry0l1t3:1234 -v
```

interaction avec openssl:

```bash
openssl s_client -connect 10.129.14.128:pop3s
```

```bash
openssl s_client -connect 10.129.14.128:imaps
```


EXPLOITATION [[SMTP - IMAP - POP3]]


---

# #MYSQL (3306)

### Footprinting

```bash
nc -vn <IP> 3306
```

```bash
sudo nmap 10.129.14.128 -sV -sC -p3306
```

##### Metasploit

```msfconsole
use scanner/mysql/mysql_version
```

### Scripts

```bash
find / -type f -name mysql* 2>/dev/null | grep scripts
```

```bash
sudo nmap 10.129.14.128 -sV -sC -p3306 --script mysql*
```

### [[Commandes SQL#MY SQL / MARIADB]]

### EXPLOITATION [[SQL]]

---

# #MSSQL (1433)


### Footprinting

```bash
sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 10.129.201.248 -vv
```

```bash
nc -vn <IP> 1433
```

##### Metasploit

```msfconsole
use scanner/mssql/mssql_ping
```


### [[Commandes SQL#MSSQL]]

### EXPLOITATION [[SQL]]



---

# #ORACLE TNS (1521)

Version `Oracle 8i`/`9i` -> Manageable à distance

Default pass version 9 ->  `CHANGE_ON_INSTALL`

### Oracle-Tools-setup.sh

```bash
#!/bin/bash

# Met à jour la liste des paquets et installe les dépendances système nécessaires
sudo apt-get update && sudo apt-get install -y \
    libaio1 python3-dev alien python3-pip \
    build-essential libgmp-dev python3-scapy

# Mise à jour de pip et installation des dépendances Python avec l'option --break-system-packages
python3 -m pip install --upgrade pip setuptools wheel --break-system-packages

# Clone du dépôt ODAT
git clone https://github.com/quentinhardy/odat.git
cd odat/

# Initialisation et mise à jour des sous-modules
git submodule init
git submodule update

# Téléchargement et extraction des Instant Clients Oracle
wget https://download.oracle.com/otn_software/linux/instantclient/2112000/instantclient-basic-linux.x64-21.12.0.0.0dbru.zip
unzip instantclient-basic-linux.x64-21.12.0.0.0dbru.zip
wget https://download.oracle.com/otn_software/linux/instantclient/2112000/instantclient-sqlplus-linux.x64-21.12.0.0.0dbru.zip
unzip instantclient-sqlplus-linux.x64-21.12.0.0.0dbru.zip

# Configuration des variables d'environnement pour Oracle Instant Client
export LD_LIBRARY_PATH=$(pwd)/instantclient_21_12:$LD_LIBRARY_PATH
export PATH=$LD_LIBRARY_PATH:$PATH

# Installation des dépendances Python globalement
pip3 install cx_Oracle colorlog termcolor passlib python-libnmap pycryptodome --break-system-packages

echo "Installation terminée. Tu peux maintenant utiliser ODAT normalement."

```
## Footprinting
#### ODAT (Oracle Database Attacking Tool)

```bash
python3 odat.py -h
```

```BASH
python3 odat.py all -s 10.129.204.235
```


```bash
sudo nmap -p1521 -sV 10.129.204.235 --open -vv
```

```bash
nc -vn <IP> 1521
```

#### Bruteforce SID

```sh
sudo nmap -p1521 -sV 10.129.204.235 --open --script oracle-sid-brute -vv
```

### [[Commandes SQL#ORACLE Tns]]

#### Upload d'un fichier sur serveur web (tester webshell)

Possible d'upload un webshell si le serveur fait tourner un serveur web -> connaitre le cheemin racine du serveur web (par defaut :  **/var/www/html/** ou **C:\inetpub\wwwroot** )

```bash
./odat.py utlfile -s 10.129.204.235 -d XE -U scott -P tiger --sysdba --putFile C:\\inetpub\\wwwroot testing.txt ./testing.txt
```


---

# #IPMI (623 udp)

Semblabe au Wake on Lan

## Baseboard Management Controllers (BMCs)

Web based management console

Default creds

| Product         | Username      | Password                                                                  |
| --------------- | ------------- | ------------------------------------------------------------------------- |
| Dell iDRAC      | root          | calvin                                                                    |
| HP iLO          | Administrator | randomized 8-character string consisting of numbers and uppercase letters |
| Supermicro IPMI | ADMIN         | ADMIN                                                                     |

### Footprinting

```bash
sudo nmap -sU --script ipmi-version -p 623 10.129.202.5
```

#### Metasploit

```msfconsole
use auxiliary/scanner/ipmi/ipmi_version 
```

Dump hashes

```msfconsole
use auxiliary/scanner/ipmi/ipmi_dumphashes 
```

### Bruteforce password HP iLO

```bash
hashcat -m 7300 ipmi.txt -a 3 ?1?1?1?1?1?1?1?1 -1 ?d?u
```


---


# #RSYNC (873)

Permet de transférer et synchroniser des fichiers sur le réseau.

https://book.hacktricks.wiki/en/network-services-pentesting/873-pentesting-rsync.html

Rsync over SSH -> https://phoenixnap.com/kb/how-to-rsync-over-ssh
## Fooprinting

```sh
sudo nmap -sV -p 873 127.0.0.1
```

```sh
nc -nv 127.0.0.1 873
```

### Enumérer les partages

```sh
rsync -av --list-only rsync://127.0.0.1/dev
```


---

# #R-SERVICES (512, 513, 514)


Permet d'administrer de l'UNIX à distance, traffic non chiffré donc vulnérable au MITM.

- rcp (`remote copy`)
- rexec (`remote execution`)
- rlogin (`remote login`)
- rsh (`remote shell`)
- rstat
- ruptime
- rwho (`remote who`)

|**Command**|**Service Daemon**|**Port**|**Transport Protocol**|**Description**|
|---|---|---|---|---|
|`rcp`|`rshd`|514|TCP|Copy a file or directory bidirectionally from the local system to the remote system (or vice versa) or from one remote system to another. It works like the `cp` command on Linux but provides `no warning to the user for overwriting existing files on a system`.|
|`rsh`|`rshd`|514|TCP|Opens a shell on a remote machine without a login procedure. Relies upon the trusted entries in the `/etc/hosts.equiv` and `.rhosts` files for validation.|
|`rexec`|`rexecd`|512|TCP|Enables a user to run shell commands on a remote machine. Requires authentication through the use of a `username` and `password` through an unencrypted network socket. Authentication is overridden by the trusted entries in the `/etc/hosts.equiv` and `.rhosts` files.|
|`rlogin`|`rlogind`|513|TCP|Enables a user to log in to a remote host over the network. It works similarly to `telnet` but can only connect to Unix-like hosts. Authentication is overridden by the trusted entries in the `/etc/hosts.equiv` and `.rhosts` files.|

Trusted remote hosts:

```sh
cat /etc/hosts.equiv
```

```sh
cat .rhosts
```

### Footprinting

```sh
sudo nmap -sV -p 512,513,514 10.0.17.2
```

### Login

```sh
rlogin 10.0.17.2 -l htb-student
```

Lister les users authentifiés (post-authent)

```sh
rwho
```

```sh
rusers -al 10.0.17.5
```


---

# #RDP (3389)

### Footprinting

```bash
nmap -sV -sC 10.129.201.248 -p3389 --script rdp* -vv
```

rdp-sec-check install:

```sh
sudo cpan
yes
install Encoding::BER
```

```bash
git clone https://github.com/CiscoCXSecurity/rdp-sec-check.git && cd rdp-sec-check;
./rdp-sec-check.pl 10.129.201.248
```

Connexion RDP XFREERDP:

```bash
xfreerdp3 /u:cry0l1t3 /p:"P455w0rd!" /v:10.129.201.248
```

Connexion RDP RDESKTOP:
```shell
rdesktop 10.10.10.132 -d HTB -u administrator -p 'Password0@'
```

Essayer remina également

### EXPLOITATION [[OFFSEC/PENTEST/2. INFRA/5. EXPLOITATION/0. Services communs/RDP]]

---

# #WINRM (5985, 5986)

Utilise SOAP pour établir les connexions.

### Footprinting

```sh
nmap -sV -sC 10.129.201.248 -p5985,5986 --disable-arp-ping -n -vv
```

### Connexion

```sh
evil-winrm -i 10.129.201.248 -u Cry0l1t3 -p P455w0rD!
```


---

# #WMI (135)


Connexion:

```sh
impacket-wmiexec Cry0l1t3:"P455w0rD!"@10.129.201.248 "hostname"
```



